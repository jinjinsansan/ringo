# オリパシステム設計ドキュメント

**作成日**: 2025年1月15日  
**ステータス**: 設計フェーズ（開発待機中）

---

## 1. システム概要

### サービス名
オリパ（仮称）- Amazonの欲しいものリスト交換プラットフォーム

### コンセプト
ユーザーが自分のAmazon欲しいものリストをプラットフォームに登録し、他のユーザーから購入してもらうことでりんごを獲得。りんごの種類に応じて、自分も他のユーザーの欲しいものリストから購入する義務と権利が発生する、ゲーム的な交換プラットフォーム。

---

## 2. ユーザーフロー

### フェーズ1：ユーザー登録・欲しいものリスト設定

```
新規ユーザー登録
  ↓
メールアドレスで登録
  ↓
マイページに遷移
  ↓
「Amazonの欲しいものリストのURLを入力」
  ↓
URLを貼り付け → 「確定」ボタンをクリック
  ↓
【重要】この時点で：
  ① URLからAmazonの欲しいものリストをスクレイピング
  ② 商品情報をデータベースに記録
  ③ URLをグレーアウト（変更不可）
  ↓
「エントリーボタン」が表示される
```

### フェーズ2：エントリー・商品表示

```
他のユーザーが「エントリーボタン」をクリック
  ↓
データベースから「まだ誰にも購入されていない欲しいものリスト」をランダムに選択
  ↓
その欲しいものリストから、ランダムに1つの商品を選択して表示
  ↓
【重要】この時点で、データベースに記録：
  - 購入者ID
  - 対象ユーザーID
  - 商品名
  - 商品URL
  - 表示日時
  ↓
ユーザーに「このAmazonの商品を購入してください」と表示
```

### フェーズ3：購入・スクリーンショット提出

```
ユーザーがAmazonで商品を購入
  ↓
購入確認画面のスクリーンショットを撮る
  ↓
アプリに戻ってスクリーンショットをアップロード
  ↓
【ステップ1】画像の前処理
  ↓
【ステップ2】OCRで情報抽出
  - 注文番号
  - 商品名
  - 金額
  - 注文日時
  ↓
【ステップ3】抽出情報の検証
  - 注文番号の形式確認
  - 金額が3000～4000円か確認
  - 注文日時が最近か確認
  ↓
【ステップ4】データベースと照合
  - スクリーンショットの商品名
    vs
  - エントリー時に記録された商品名
  ↓
【ステップ5】判定結果を返却
  ✅ APPROVED
  ⚠️ REVIEW_REQUIRED
  ❌ REJECTED
```

### フェーズ4：りんご抽選

```
購入が確認されたら
  ↓
購入者にりんご抽選権が付与される
  ↓
「りんごを引く」ボタンをクリック
  ↓
確率に基づいてりんごが決定
  ↓
りんごの種類に応じて「購入義務回数」と「購入してもらえる回数」が決定
```

---

## 3. りんごの種類と仕組み

### りんごの定義

| りんご | 購入義務 | 購入してもらえる回数 | 説明 |
|--------|---------|------------------|------|
| ブロンズりんご | 1回 | 1回 | 基本的なりんご |
| シルバーりんご | 1回 | 2回 | より多くの人に買ってもらえる |
| ゴールドりんご | 1回 | 3回 | さらに多くの人に買ってもらえる |
| 赤いりんご | 1回 | 10回 | 最高レアのりんご |
| 毒りんご | 1回 | 0回 | ハズレ。誰にも買ってもらえない |

### 確率設計

紹介人数に基づいて確率が変動する。上位りんご（赤いりんご、ゴールド）を引くと、紹介カウントがリセットされる。

| 紹介人数 | ブロンズ | シルバー | ゴールド | 赤いりんご | 毒りんご |
|---------|---------|---------|---------|-----------|---------|
| 0人 | 60% | 25% | 10% | 3% | 2% |
| 1人 | 50% | 30% | 15% | 4% | 1% |
| 2人 | 40% | 35% | 18% | 5% | 2% |
| 3人以上 | 30% | 35% | 25% | 8% | 2% |

---

## 4. 購入検証メカニズム

### 検証方法：AI自動確認 + スクリーンショット

#### ステップ1：画像の前処理
- 画像の回転補正
- コントラスト調整
- ノイズ除去
- グレースケール化

#### ステップ2：OCR（光学文字認識）で情報抽出
使用技術：**GPT-4 Vision API**（精度95%以上）

抽出項目：
- 注文番号（Amazon形式：123-4567890-1234567）
- 商品名
- 金額
- 注文日時
- 販売者

#### ステップ3：抽出情報の検証
- 注文番号の形式確認
- 金額が3000～4000円の範囲内か確認
- 注文日時が当日または前日か確認
- 販売者がAmazon.co.jpか確認
- OCR信頼度が70%以上か確認

#### ステップ4：データベースと照合
- スクリーンショットの商品名
- vs
- エントリー時に記録された商品名
- 完全一致、部分一致、類似度85%以上で照合

#### ステップ5：判定結果の返却
- **✅ APPROVED**：購入が確認された → りんご抽選権付与
- **⚠️ REVIEW_REQUIRED**：要確認 → 管理者に通知
- **❌ REJECTED**：購入が確認できない → 却下

---

## 5. データベース設計

### テーブル1：ユーザー（users）

```
id (PK)
email (UNIQUE)
password_hash
wishlist_url
wishlist_locked (Boolean)
referral_code (UNIQUE)
referred_by (FK to users.id)
referral_count (Integer)
apple_draw_rights (Integer)
created_at
updated_at
```

### テーブル2：欲しいものリスト商品（wishlist_items）

```
id (PK)
user_id (FK)
product_name
product_url
product_asin
price
is_purchased (Boolean)
purchased_by_user_id (FK)
purchased_at
created_at
```

### テーブル3：エントリー（entries）

```
id (PK)
buyer_id (FK)
seller_id (FK)
wishlist_item_id (FK)
product_name
product_url
screenshot_url
order_number
purchase_price
purchase_date
verification_status (APPROVED / REVIEW_REQUIRED / REJECTED)
verified_at
apple_id (FK)
created_at
```

### テーブル4：りんご（apples）

```
id (PK)
user_id (FK)
apple_type (BRONZE / SILVER / GOLD / RED / POISON)
purchase_obligation (Integer)
purchase_available (Integer)
purchase_obligation_remaining (Integer)
purchase_available_remaining (Integer)
created_at
completed_at
```

---

## 6. 紹介機能

### 紹介コード
- 8文字のランダムコード（例：ABC12XYZ）
- QRコード化も可能
- ユーザーが登録時に紹介コードを入力 → 紹介者のカウントが+1

### 紹介精度メカニズム
- 紹介人数が増えるほど、上位りんごを引く確率が上昇
- 上位りんご（赤いりんご、ゴールド）を引くと、紹介カウントがリセット
- ユーザーは友達紹介を頑張ることで、再び上位りんごを引く確率を上げられる

---

## 7. 技術スタック

### フロントエンド
- **フレームワーク**: React + TypeScript
- **スタイリング**: TailwindCSS
- **ビルドツール**: Vite

### バックエンド
- **フレームワーク**: FastAPI (Python)
- **データベース**: MySQL / TiDB
- **ORM**: SQLAlchemy / Drizzle

### AI・画像処理
- **OCR**: GPT-4 Vision API
- **画像処理**: OpenCV
- **言語処理**: Python

### インフラ
- **ホスティング**: AWS / GCP
- **ストレージ**: S3
- **認証**: JWT

---

## 8. 重要な設計決定

### 1. 欲しいものリストのスクレイピング
- **初回のみ実施**（URLを確定した時点）
- 以降は記録されたデータを使用
- Amazonの利用規約違反を最小化

### 2. 購入検証方法
- **毎回スクリーンショット必須**
- AI自動確認で即座に結果を返却
- 不正を大幅に減らす

### 3. 商品照合
- エントリー時に記録された商品名と照合
- 購入後の欲しいものリスト削除を回避
- 不正防止

### 4. 確率設計
- 紹介人数に基づいて確率が変動
- 上位りんご引後にリセット
- ゲーム性と公平性のバランス

---

## 9. トークン消費見積もり

### 初期開発
- **MVP**: 150,000トークン
- **フル機能**: 310,000トークン

### 月間運用
- **50,000トークン/月**

### 年間合計
- **フル機能 + 運用**: 910,000トークン

---

## 10. 次のステップ

### 検討項目
- [ ] 確率設計の最終調整
- [ ] UI/UXのモックアップ作成
- [ ] セキュリティ要件の詳細化
- [ ] スケーラビリティ要件の確認
- [ ] コスト試算（AWS/GCP）
- [ ] ユーザー獲得戦略
- [ ] マネタイズ方法の検討

### 開発前の確認事項
- [ ] Amazonへの事前確認（スクレイピング許可）
- [ ] 利用規約の作成
- [ ] プライバシーポリシーの作成
- [ ] 不正検出・対応ポリシーの策定

---

## 11. 未決定事項

### ビジネスモデル
- サービスの収益化方法は？
- ユーザー獲得コストは？
- 運用コストの回収方法は？

### 機能
- ユーザー間のメッセージング機能は必要か？
- ユーザーレビュー・評価機能は必要か？
- ウィッシュリスト以外の商品カテゴリは対応するか？

### 運用
- 不正ユーザーへのペナルティは？
- カスタマーサポートの体制は？
- 定期メンテナンスのスケジュールは？

---

**最終更新**: 2025年1月15日  
**次回レビュー**: 設計詳細化後
